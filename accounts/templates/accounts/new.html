<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Saved Routes</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.8.0/dist/leaflet.css" />
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
        }

        h1, h2 {
            text-align: center;
            padding: 20px 0;
            background-color: #f4f4f4;
            margin: 0;
        }

        #map {
            width: 100%;
            height: 50vh;
        }

        table {
            width: 100%;
            margin-top: 20px;
            border-collapse: collapse;
        }

        table, th, td {
            border: 1px solid #ccc;
        }

        th, td {
            padding: 10px;
            text-align: left;
        }

        td {
            cursor: pointer;
        }
    </style>
</head>

<body>

    <h1>Saved Routes</h1>

    <!-- Table displaying saved route data -->
    <table>
        <thead>
            <tr>
                <th>Route Name</th>
                <th>Starting Point</th>
                <th>Destination</th>
            </tr>
        </thead>
        <tbody>
            {% for route in routes %}
            <tr onclick="showRouteDetails('{{ route.route_name }}', {{ route.route_data|safe }}, '{{ route.starting_point }}', '{{ route.destination }}')">
                <td>{{ route.route_name }}</td>
                <td>{{ route.starting_point }}</td>
                <td>{{ route.destination }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <h2>Bus Stops</h2>

    <!-- Table displaying all bus stops -->
    <table id="bus-stops-table">
        <thead>
            <tr>
                <th>Bus Stop Name</th>
                <th>Latitude</th>
                <th>Longitude</th>
            </tr>
        </thead>
        <tbody>
            <!-- Content will be dynamically updated -->
        </tbody>
    </table>

    <h2>Venue Owner Details</h2>

    <!-- Table displaying venue owner details -->
    <table id="owner-details-table" style="">
        <thead>
            <tr>
                <th>Owner Name</th>
                <th>Email</th>
                <th>Phone</th>
                <th>Venue Name</th>
            </tr>
        </thead>
        <tbody>
            <!-- Content will be dynamically updated -->
        </tbody>
    </table>

    <!-- Map to display the routes -->
    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.8.0/dist/leaflet.js"></script>
    <script>
        // Initialize the map
        let map = L.map('map');
        
        // Custom icon for the user's location
        const userLocationIcon = L.icon({
            iconUrl: '/static/images/userloc.png', // Path to your custom icon
            iconSize: [32, 32],  // Size of the icon
            iconAnchor: [16, 32], // Anchor the icon at the bottom center
            popupAnchor: [0, -32] // Position of the popup relative to the icon
        });
        
        // Use geolocation to center the map on the user's current location
        navigator.geolocation.getCurrentPosition(function(position) {
            const userLat = position.coords.latitude;
            const userLng = position.coords.longitude;

            // Center the map on the user's location
            map.setView([userLat, userLng], 13);

            // Add the tile layer (map tiles from OpenStreetMap)
            L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png', {
                attribution: 'Leaflet &copy; <a href="http://openstreetmap.org">OpenStreetMap</a>',
                maxZoom: 18
            }).addTo(map);

            // Add a marker for the user's location with custom icon
            L.marker([userLat, userLng], { icon: userLocationIcon })
                .addTo(map)
                .bindPopup('Your current location')
                .openPopup();
        }, function() {
            // If geolocation fails, fall back to default coordinates
            map.setView([28.2380, 83.9956], 11);  // Default coordinates (fallback)
            L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png', {
                attribution: 'Leaflet &copy; <a href="http://openstreetmap.org">OpenStreetMap</a>',
                maxZoom: 18
            }).addTo(map);
        });

        let routeLine;
        let markers = [];
        let busStopMarkers = [];
        let venueOwnerMarkers = [];

        const busStops = [
            {% for bus_stop in all_bus_stops %}
                {
                    name: "{{ bus_stop.name }}",
                    latitude: {{ bus_stop.latitude }},
                    longitude: {{ bus_stop.longitude }},
                    route: "{{ bus_stop.route }}"
                },
            {% endfor %}
        ];

        const venueOwners = [
            {% for owner in owners %}
                {
                    username: "{{ owner.username }}",
                    route: "{{ owner.route }}",
                    bus_registration: "{{ owner.registration_number }}",
                    verified: "{{ owner.verified }}",
                    latitude: "{{ owner.latitude }}",
                    longitude: "{{ owner.longitude }}"
                },
            {% endfor %}
        ];

        function showRouteDetails(routeName, routeCoordinates, startingPoint, destination) {
            // Clear previous route and markers
            if (routeLine) {
                map.removeLayer(routeLine);
            }
            markers.forEach(marker => map.removeLayer(marker));
            markers = [];

            // Draw the route
            const parsedCoordinates = typeof routeCoordinates === 'string' ? JSON.parse(routeCoordinates) : routeCoordinates;
            routeLine = L.polyline(parsedCoordinates.map(coord => [coord.lat, coord.lng]), {
                color: 'blue',
                weight: 5
            }).addTo(map);

            // Add starting and destination markers
            const startingLatLng = L.latLng(parsedCoordinates[0].lat, parsedCoordinates[0].lng);
            const destinationLatLng = L.latLng(parsedCoordinates[parsedCoordinates.length - 1].lat, parsedCoordinates[parsedCoordinates.length - 1].lng);

            const blueIcon = L.icon({
                iconUrl: 'https://unpkg.com/leaflet@1.8.0/dist/images/marker-icon.png',
                iconSize: [25, 41],
                iconAnchor: [12, 41]
            });

            const startMarker = L.marker(startingLatLng, { icon: blueIcon }).addTo(map).bindPopup('Starting Point: ' + startingPoint).openPopup();
            const endMarker = L.marker(destinationLatLng, { icon: blueIcon }).addTo(map).bindPopup('Destination: ' + destination);

            markers.push(startMarker, endMarker);
            map.fitBounds(routeLine.getBounds());

            // Display bus stops related to the route
            displayBusStops(routeName);

            // Display venue owner details related to the route
            displayVenueOwners(routeName);
        }

        function displayBusStops(routeName) {
            // Clear previous bus stop markers
            busStopMarkers.forEach(marker => map.removeLayer(marker));
            busStopMarkers = [];

            // Update bus stops table and map
            const tableBody = document.querySelector('#bus-stops-table tbody');
            tableBody.innerHTML = '';

            const redIcon = L.icon({
                iconUrl: '/static/images/busstop.png',
                iconSize: [45, 41],
                iconAnchor: [19, 41]
            });

            busStops.filter(busStop => busStop.route === routeName).forEach(busStop => {
                // Add bus stop to the map
                const busStopLatLng = L.latLng(busStop.latitude, busStop.longitude);
                const busStopMarker = L.marker(busStopLatLng, { icon: redIcon })
                    .addTo(map)
                    .bindPopup(busStop.name);
                busStopMarkers.push(busStopMarker);

                // Add bus stop to the table
                const row = `<tr>
                    <td>${busStop.name}</td>
                    <td>${busStop.latitude}</td>
                    <td>${busStop.longitude}</td>
                </tr>`;
                tableBody.insertAdjacentHTML('beforeend', row);
            });
        }

        function displayVenueOwners(routeName) {
            // Clear previous venue owner markers
            venueOwnerMarkers.forEach(marker => map.removeLayer(marker));
            venueOwnerMarkers = [];

            // Update venue owner table
            const tableBody = document.querySelector('#owner-details-table tbody');
            tableBody.innerHTML = '';

            // Custom icon for venue owners
            const ownerIcon = L.icon({
                iconUrl: '/static/images/download1.png', // Path to custom icon
                iconSize: [30, 30],  // Adjust the size as needed
                iconAnchor: [15, 30], // Anchor the icon at the bottom center
                popupAnchor: [0, -30] // Adjust popup position relative to the icon
            });

            venueOwners.filter(owner => owner.route === routeName && owner.verified).forEach(owner => {
                // Add venue owner to the map with custom icon
                const ownerLatLng = L.latLng(owner.latitude, owner.longitude);
                const ownerMarker = L.marker(ownerLatLng, { icon: ownerIcon })
                    .addTo(map)
                    .bindPopup(`
                        <strong>Owner: ${owner.username}</strong><br>
                        Bus Registration: ${owner.bus_registration}<br>
                        Latitude: ${owner.latitude}<br>
                        Longitude: ${owner.longitude}<br>
                        Verified: ${owner.verified ? 'Yes' : 'No'}
                    `);
                venueOwnerMarkers.push(ownerMarker);

                // Add venue owner to the table
                const row = `<tr>
                    <td>${owner.username}</td>
                    <td>${owner.latitude}</td>
                    <td>${owner.longitude}</td>
                    <td>${owner.bus_registration}</td>
                </tr>`;
                tableBody.insertAdjacentHTML('beforeend', row);
            });
        }
        
        // New function to fetch route details from an API and show on the map
    
    </script>
</body>

</html>
